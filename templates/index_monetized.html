{% extends "base.html" %}

{% block title %}Generate Map - Map Contour Mapper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Header with Credits -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="display-5 fw-bold text-primary">
                    <i class="fas fa-mountain"></i> Create Your Map
                </h1>
                <p class="lead text-muted">Generate beautiful elevation contour maps</p>
            </div>
            <div class="text-end">
                <div class="card border-primary">
                    <div class="card-body text-center p-3">
                        <h5 class="card-title text-primary mb-1">
                            <i class="fas fa-coins"></i> {{ credits }}
                        </h5>
                        <small class="text-muted">credits remaining</small>
                        {% if credits < 3 %}
                            <div class="mt-2">
                                <a href="{{ url_for('purchase_credits') }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-plus"></i> Buy More
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Credit Warning -->
        {% if credits == 0 %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>No credits remaining!</strong> 
                <a href="{{ url_for('purchase_credits') }}" class="alert-link">Purchase credits</a> to generate more maps.
            </div>
        {% elif credits <= 2 %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Low on credits!</strong> 
                <a href="{{ url_for('purchase_credits') }}" class="alert-link">Consider purchasing more</a> to avoid interruption.
            </div>
        {% endif %}

        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('generate') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-map-marked-alt text-primary"></i> Location & Area
                            </h5>
                            
                            <div class="mb-3">
                                <label for="bbox" class="form-label">
                                    <i class="fas fa-map-marked-alt"></i> Select Area
                                </label>
                                
                                <!-- Interactive Map -->
                                <div class="card mb-3">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-mouse-pointer"></i> 
                                                <span class="d-none d-md-inline">Hold <kbd>Shift</kbd> and drag to select area</span>
                                                <span class="d-md-none">Tap "Draw Mode" then tap two corners to select area</span>
                                            </small>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <!-- Mobile draw mode toggle -->
                                                <button type="button" class="btn btn-outline-success d-md-none" id="drawModeBtn" onclick="toggleDrawMode()">
                                                    <i class="fas fa-draw-polygon"></i> Draw Mode
                                                </button>
                                            </div>
                                        </div>
                                        <div id="map" style="height: 300px; width: 100%; border-radius: 8px;"></div>
                                    </div>
                                </div>
                                
                                <!-- Coordinate Input (sync with map) -->
                                <input type="text" class="form-control" id="bbox" name="bbox" 
                                       placeholder="min_lon,min_lat,max_lon,max_lat" 
                                       value="7.1,43.6,7.4,43.8" required>
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i> 
                                    Coordinates will update automatically when you draw on the map above<br>
                                    Or enter manually: <code>min_longitude,min_latitude,max_longitude,max_latitude</code>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-palette text-primary"></i> Appearance
                            </h5>
                            
                            <div class="mb-3">
                                <label for="interval" class="form-label">Contour Interval (meters)</label>
                                <input type="number" class="form-control" id="interval" name="interval" 
                                       value="10" min="1" max="100" step="1" required>
                                <div class="form-text">Distance between contour lines in meters</div>
                            </div>

                            <div class="mb-3">
                                <label for="background_color" class="form-label">Background Color</label>
                                <div class="input-group">
                                    <input type="color" class="form-control form-control-color" 
                                           id="background_color_picker" value="#FFB366" 
                                           title="Choose background color">
                                    <input type="text" class="form-control" id="background_color" 
                                           name="background_color" value="#FFB366" 
                                           placeholder="#ffffff" pattern="^#[0-9A-Fa-f]{6}$" required>
                                </div>
                                <div class="form-text">Hex color code (e.g., #FFB366 for light orange)</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="roads" name="roads">
                                    <label class="form-check-label" for="roads">
                                        <i class="fas fa-road"></i> Include Roads
                                    </label>
                                    <div class="form-text">Overlay road network on the map</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-md-12">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-expand-arrows-alt text-primary"></i> Output Settings
                            </h5>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="resolution" class="form-label">Output Size</label>
                                <select class="form-select" id="resolution" name="resolution">
                                    <option value="800">Small (800px width)</option>
                                    <option value="1600" selected>Medium (1600px width)</option>
                                    <option value="3200">Large (3200px width)</option>
                                    <option value="4800">Extra Large (4800px width)</option>
                                </select>
                                <div class="form-text">
                                    Height will be automatically calculated to match your selected area's aspect ratio
                                </div>
                                <input type="hidden" id="width" name="width" value="1600">
                                <input type="hidden" id="height" name="height" value="1200">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Calculated Size</label>
                                <div class="form-control-plaintext" id="calculated-size">
                                    <small class="text-muted">
                                        <span id="display-dimensions">1600 Ã— 1200</span><br>
                                        <span id="display-ratio">Ratio: 4:3</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        {% if credits > 0 %}
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-map"></i> Generate Contour Map (1 Credit)
                            </button>
                        {% else %}
                            <a href="{{ url_for('purchase_credits') }}" class="btn btn-warning btn-lg">
                                <i class="fas fa-shopping-cart"></i> Purchase Credits to Generate Maps
                            </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Navigation Links -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card border-0">
                    <div class="card-body text-center">
                        <a href="{{ url_for('my_maps') }}" class="btn btn-outline-primary">
                            <i class="fas fa-images"></i> My Maps
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0">
                    <div class="card-body text-center">
                        <a href="{{ url_for('purchase_credits') }}" class="btn btn-outline-success">
                            <i class="fas fa-coins"></i> Buy Credits
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0">
                    <div class="card-body text-center">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-sign-out-alt"></i> Log Out
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize the map
    let map, currentRectangle;
    let isMobileDrawMode = false;
    
    function initMap() {
        // Create map centered on Nice, France
        map = L.map('map').setView([43.7, 7.25], 10);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Add draw control for rectangle (desktop only for now - mobile uses button)
        map.on('mousedown', startDrawing);
        
        // For mobile, we'll use a simpler click-based approach
        map.on('click', handleMapClick);
        
        // Initialize with current bbox
        updateMapFromInput();
    }
    
    let isDrawing = false;
    let startLatLng;
    let mobileCorner1 = null; // First corner for mobile selection
    
    // Toggle mobile draw mode
    function toggleDrawMode() {
        isMobileDrawMode = !isMobileDrawMode;
        const btn = document.getElementById('drawModeBtn');
        
        if (isMobileDrawMode) {
            btn.innerHTML = '<i class="fas fa-times"></i> Exit Draw';
            btn.className = 'btn btn-danger d-md-none';
            mobileCorner1 = null; // Reset corners
        } else {
            btn.innerHTML = '<i class="fas fa-draw-polygon"></i> Draw Mode';
            btn.className = 'btn btn-outline-success d-md-none';
            mobileCorner1 = null; // Reset corners
        }
    }
    
    // Simple click-based selection for mobile
    function handleMapClick(e) {
        if (!isMobileDrawMode) return;
        
        if (!mobileCorner1) {
            // First click - set first corner
            mobileCorner1 = e.latlng;
            
            // Add a temporary marker
            if (window.tempMarker1) map.removeLayer(window.tempMarker1);
            window.tempMarker1 = L.marker(mobileCorner1).addTo(map);
            
            // Update button text
            const btn = document.getElementById('drawModeBtn');
            btn.innerHTML = '<i class="fas fa-map-marker"></i> Tap 2nd Corner';
            
        } else {
            // Second click - create rectangle
            const corner2 = e.latlng;
            
            // Remove temporary marker
            if (window.tempMarker1) map.removeLayer(window.tempMarker1);
            
            // Create rectangle
            if (currentRectangle) map.removeLayer(currentRectangle);
            const bounds = L.latLngBounds(mobileCorner1, corner2);
            currentRectangle = L.rectangle(bounds, {
                color: '#007bff',
                weight: 2,
                fillOpacity: 0.2
            }).addTo(map);
            
            // Update bbox input
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            const bbox = `${sw.lng.toFixed(4)},${sw.lat.toFixed(4)},${ne.lng.toFixed(4)},${ne.lat.toFixed(4)}`;
            document.getElementById('bbox').value = bbox;
            
            // Update resolution calculation
            updateResolutionCalculation(sw.lng, sw.lat, ne.lng, ne.lat);
            
            // Exit draw mode
            toggleDrawMode();
        }
    }
    
    function startDrawing(e) {
        // Desktop: require Shift key, Mobile: require draw mode to be enabled
        const isDesktop = e.originalEvent && e.originalEvent.shiftKey;
        const isMobile = isMobileDrawMode;
        
        if (isDesktop || isMobile) {
            isDrawing = true;
            startLatLng = e.latlng;
            map.dragging.disable();
            
            // Add event listeners for both mouse and touch
            map.on('mousemove', updateDrawing);
            map.on('mouseup', finishDrawing);
            map.on('touchmove', handleTouchMove);
            map.on('touchend', handleTouchEnd);
            
            if (e.originalEvent && e.originalEvent.preventDefault) {
                e.originalEvent.preventDefault(); // Prevent default touch behavior
            }
        }
    }
    
    function handleTouchMove(e) {
        if (!isDrawing) return;
        // Convert touch to mouse-like event
        if (e.originalEvent && e.originalEvent.touches && e.originalEvent.touches.length > 0) {
            const touch = e.originalEvent.touches[0];
            const fakeEvent = {
                latlng: map.containerPointToLatLng([touch.clientX - map.getContainer().offsetLeft, touch.clientY - map.getContainer().offsetTop])
            };
            updateDrawing(fakeEvent);
        }
    }
    
    function handleTouchEnd(e) {
        if (!isDrawing) return;
        finishDrawing(e);
    }
    
    function updateDrawing(e) {
        if (!isDrawing) return;
        
        // Remove previous rectangle
        if (currentRectangle) {
            map.removeLayer(currentRectangle);
        }
        
        // Create new rectangle
        const bounds = L.latLngBounds(startLatLng, e.latlng);
        currentRectangle = L.rectangle(bounds, {
            color: '#007bff',
            weight: 2,
            fillOpacity: 0.2
        }).addTo(map);
    }
    
    function finishDrawing(e) {
        if (!isDrawing) return;
        
        isDrawing = false;
        map.dragging.enable();
        map.off('mousemove', updateDrawing);
        map.off('mouseup', finishDrawing);
        map.off('touchmove', handleTouchMove);
        map.off('touchend', handleTouchEnd);
        
        if (currentRectangle) {
            const bounds = currentRectangle.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            
            // Update input field
            const bbox = `${sw.lng.toFixed(4)},${sw.lat.toFixed(4)},${ne.lng.toFixed(4)},${ne.lat.toFixed(4)}`;
            document.getElementById('bbox').value = bbox;
            
            // Update resolution calculation
            updateResolutionCalculation(sw.lng, sw.lat, ne.lng, ne.lat);
            
            // Exit mobile draw mode after drawing
            if (isMobileDrawMode) {
                toggleDrawMode();
            }
        }
    }
    
    function updateMapFromInput() {
        const bboxInput = document.getElementById('bbox').value;
        if (bboxInput) {
            const coords = bboxInput.split(',').map(parseFloat);
            if (coords.length === 4) {
                const [minLon, minLat, maxLon, maxLat] = coords;
                
                // Remove existing rectangle
                if (currentRectangle) {
                    map.removeLayer(currentRectangle);
                }
                
                // Add new rectangle
                const bounds = L.latLngBounds([minLat, minLon], [maxLat, maxLon]);
                currentRectangle = L.rectangle(bounds, {
                    color: '#007bff',
                    weight: 2,
                    fillOpacity: 0.2
                }).addTo(map);
                
                // Fit map to bounds
                map.fitBounds(bounds, { padding: [20, 20] });
                
                // Update resolution calculation
                updateResolutionCalculation(minLon, minLat, maxLon, maxLat);
            }
        }
    }
    
    function updateResolutionCalculation(minLon, minLat, maxLon, maxLat) {
        // Calculate aspect ratio of the bounding box
        const lonDiff = maxLon - minLon;
        const latDiff = maxLat - minLat;
        
        // Validate differences to avoid NaN
        if (!lonDiff || !latDiff || lonDiff <= 0 || latDiff <= 0) {
            // Use default square ratio if invalid coordinates
            const selectedWidth = parseInt(document.getElementById('resolution').value) || 1600;
            document.getElementById('width').value = selectedWidth;
            document.getElementById('height').value = selectedWidth; // Square aspect
            document.getElementById('display-dimensions').textContent = `${selectedWidth} Ã— ${selectedWidth}`;
            document.getElementById('display-ratio').textContent = `Ratio: 1:1`;
            return;
        }
        
        // Calculate proper aspect ratio accounting for latitude
        // Use Mercator projection approximation for better accuracy
        const avgLat = (minLat + maxLat) / 2;
        const latCorrectionFactor = Math.cos(avgLat * Math.PI / 180);
        const correctedLonDiff = lonDiff * latCorrectionFactor;
        const aspectRatio = correctedLonDiff / latDiff;
        
        // Get selected width and validate
        const selectedWidth = parseInt(document.getElementById('resolution').value) || 1600;
        let calculatedHeight = Math.round(selectedWidth / aspectRatio);
        
        // Validate calculated height and ensure it's reasonable
        if (!calculatedHeight || calculatedHeight <= 0 || !isFinite(calculatedHeight)) {
            calculatedHeight = selectedWidth; // Fallback to square
        }
        
        // Ensure height is within reasonable bounds
        calculatedHeight = Math.max(100, Math.min(calculatedHeight, 10000));
        
        // Update hidden fields
        document.getElementById('width').value = selectedWidth;
        document.getElementById('height').value = calculatedHeight;
        
        // Update display
        document.getElementById('display-dimensions').textContent = `${selectedWidth} Ã— ${calculatedHeight}`;
        
        // Calculate and display simplified ratio
        try {
            const gcd = function(a, b) { return b === 0 ? a : gcd(b, a % b); };
            const ratio = gcd(selectedWidth, calculatedHeight);
            const ratioW = Math.round(selectedWidth / ratio);
            const ratioH = Math.round(calculatedHeight / ratio);
            
            if (isFinite(ratioW) && isFinite(ratioH) && ratioW > 0 && ratioH > 0) {
                document.getElementById('display-ratio').textContent = `Ratio: ${ratioW}:${ratioH}`;
            } else {
                document.getElementById('display-ratio').textContent = `Ratio: 1:1`;
            }
        } catch (e) {
            document.getElementById('display-ratio').textContent = `Ratio: 1:1`;
        }
    }
    
    function goToLocation(minLon, minLat, maxLon, maxLat) {
        const bbox = `${minLon},${minLat},${maxLon},${maxLat}`;
        document.getElementById('bbox').value = bbox;
        updateMapFromInput();
    }
    
    // Sync color picker with text input
    document.getElementById('background_color_picker').addEventListener('change', function() {
        document.getElementById('background_color').value = this.value;
    });
    
    document.getElementById('background_color').addEventListener('change', function() {
        document.getElementById('background_color_picker').value = this.value;
    });
    
    // Update map when input changes
    document.getElementById('bbox').addEventListener('input', updateMapFromInput);
    
    // Update resolution when selection changes
    document.getElementById('resolution').addEventListener('change', function() {
        const bboxInput = document.getElementById('bbox').value;
        if (bboxInput) {
            const coords = bboxInput.split(',').map(parseFloat);
            if (coords.length === 4) {
                updateResolutionCalculation(coords[0], coords[1], coords[2], coords[3]);
            }
        }
    });
    
    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
    });
</script>
{% endblock %}
